---
import Layout from '../layouts/Layout.astro';
import { loadScrapingData, getAllEvents, getAthletesByEvent } from '../utils/dataUtils';

const data = loadScrapingData();
const athletes = data.data;
const allEvents = getAllEvents(athletes);

// Calcular estadÃ­sticas por evento
const eventStats = allEvents.map(event => {
    const athletesInEvent = getAthletesByEvent(athletes, event);
    const totalPBs = athletesInEvent.reduce((sum, athlete) => 
        sum + athlete.personalBests.filter(pb => pb.event === event).length, 0
    );
    const totalSeasonalBests = athletesInEvent.reduce((sum, athlete) => 
        sum + athlete.seasonalBests.filter(sb => sb.event === event).length, 0
    );
    
    return {
        event,
        athletes: athletesInEvent.length,
        totalPBs,
        totalSeasonalBests,
        totalMarks: totalPBs + totalSeasonalBests
    };
});

// Ordenar por nÃºmero de atletas
eventStats.sort((a, b) => b.athletes - a.athletes);
---

<Layout title="Eventos - Atletismo Stats">
    <div class="page-title">ðŸ“Š Eventos Deportivos</div>
    <p class="page-description">
        Lista completa de eventos con estadÃ­sticas de participaciÃ³n y marcas registradas.
    </p>

    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-number">{allEvents.length}</div>
            <div class="stat-label">Eventos Totales</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{eventStats.reduce((sum, event) => sum + event.totalPBs, 0)}</div>
            <div class="stat-label">Marcas Personales</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{eventStats.reduce((sum, event) => sum + event.totalSeasonalBests, 0)}</div>
            <div class="stat-label">Mejores de Temporada</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{eventStats.reduce((sum, event) => sum + event.athletes, 0)}</div>
            <div class="stat-label">Participaciones</div>
        </div>
    </div>

    <div class="grid grid-cols-1">
        {eventStats.map(eventStat => (
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        <a href={`/events/${encodeURIComponent(eventStat.event)}`} style="color: white; text-decoration: none;">
                            {eventStat.event}
                        </a>
                    </h3>
                    <p class="card-subtitle">{eventStat.athletes} atletas participando</p>
                </div>
                <div class="card-body">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number">{eventStat.athletes}</div>
                            <div class="stat-label">Atletas</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">{eventStat.totalPBs}</div>
                            <div class="stat-label">Marcas Personales</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">{eventStat.totalSeasonalBests}</div>
                            <div class="stat-label">Mejores 2025</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">{eventStat.totalMarks}</div>
                            <div class="stat-label">Total Marcas</div>
                        </div>
                    </div>

                    <div style="margin-top: 1.5rem;">
                        <a href={`/events/${encodeURIComponent(eventStat.event)}`} class="btn">Ver Ranking</a>
                        <a href={`/rankings?event=${encodeURIComponent(eventStat.event)}`} class="btn btn-secondary" style="margin-left: 1rem;">Comparar Marcas</a>
                    </div>
                </div>
            </div>
        ))}
    </div>

    {allEvents.length === 0 && (
        <div class="card">
            <div class="card-body" style="text-align: center; padding: 3rem;">
                <p style="color: var(--text-secondary); font-size: 1.1rem;">
                    No hay eventos disponibles.
                </p>
            </div>
        </div>
    )}
</Layout>
